<!doctype html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>バーチャル・イシュー（教育）リンク集</title>
<style>
  :root{--gap:14px}
  body{font-family:system-ui,"Noto Sans JP",sans-serif;margin:24px}
  header{display:flex;flex-wrap:wrap;gap:var(--gap);align-items:center;margin-bottom:var(--gap)}
  input,select,button{padding:.6rem .7rem;font-size:16px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:var(--gap)}
  .card{border:1px solid #e5e7eb;border-radius:14px;padding:16px}
  .muted{color:#6b7280;font-size:0.9em}
  .warn{color:#b45309}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .tag{background:#eef2ff;border:1px solid #e0e7ff;border-radius:999px;padding:.1rem .6rem;font-size:.85em}
  a{color:#1f6feb;text-decoration:none}
  a:hover{text-decoration:underline}
  .pill{border:1px solid #e5e7eb;border-radius:999px;padding:.3rem .6rem;display:inline-block}
  .right{margin-left:auto}
  .btn{cursor:pointer;background:#fff}
  .dead{pointer-events:none;color:#94a3b8;text-decoration:none}
  #dbgBtn{position:fixed;right:12px;top:10px}
  #dbg{position:fixed;right:12px;top:48px;width:min(520px,90vw);height:40vh;overflow:auto;background:#0b1020;color:#d1d5db;border:1px solid #1f2937;border-radius:12px;padding:10px;display:none;white-space:pre-wrap;font:12px/1.4 ui-monospace,Menlo,Consolas,monospace}
  .kw { background:#ecfeff; border:1px solid #cffafe; border-radius:999px; padding:.1rem .6rem; font-size:.85em }
</style>
</head>
<body>
<header>
  <input id="q" placeholder="タイトル / 著者 / 誌名 / URL / タグで検索" oninput="render()" />
  <select id="sort" onchange="render()">
    <option value="year-desc">新しい順</option>
    <option value="year-asc">古い順</option>
    <option value="title-asc">タイトルA→Z</option>
    <option value="title-desc">タイトルZ→A</option>
  </select>
  <label class="pill"><input id="eduOnly" type="checkbox" onchange="render()"> 教育のみ</label>
  <span id="count" class="pill"></span>
  <span class="right muted">ソース: <code>items.cache.json</code>（無ければ <code>items.csv</code>）</span>
</header>

<button id="dbgBtn" class="pill btn" onclick="toggleDbg()">🧪デバッグ</button>
<pre id="dbg"></pre>

<div id="list" class="grid" style="margin-top:8px">
  <div class="muted">読み込み中…</div>
</div>

<script>
/* ==== 設定（環境に合わせて必要なら変更） ==== */
const REPO_HOST = 'hokuriku.repo.nii.ac.jp'; // WEKOホスト
const EDU_SET_PREFIX = '29';                  // 教育セット判定
const ROOT = location.pathname.replace(/\/[^/]*$/, '/'); // この index.html のディレクトリ
const CSV_URL = new URL('items.csv', location.href).toString();
const CACHE_URL = new URL('items.cache.json', location.href).toString();

/* ==== デバッグ ==== */
const $dbg=()=>document.getElementById('dbg');
function log(...a){ console.log(...a); try{$dbg().textContent+=a.map(x=>typeof x==='string'?x:JSON.stringify(x)).join(' ')+'\n';}catch{} }
function toggleDbg(){ const el=$dbg(); el.style.display=el.style.display==='none'?'block':'none'; }
window.addEventListener('error', e=>log('onerror:', e.message));
window.addEventListener('unhandledrejection', e=>log('unhandledrejection:', String(e.reason||e)));

/* ==== ユーティリティ ==== */
const norm = s => (s||'').toString().toLowerCase();
const escapeHtml = s => (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
const isHttp = s => /^https?:\/\//i.test(s||'');
const isDOI  = s => /^10\.\S+\/\S+$/i.test((s||'').trim());
const isWekoUrl = u => /\/records?\/\d+/.test(u||'');

function splitCsvLine(line){ const re=/("([^"]|"")*"|[^,]+)/g; const out=[]; let m; while((m=re.exec(line))!==null) out.push(m[0].replace(/^"(.*)"$/,'$1').replace(/""/g,'"')); return out.map(s=>s.trim()); }
async function fetchCsv(url){
  log('fetchCsv:', url);
  const r = await fetch(url,{cache:'no-store'});
  log('fetchCsv status:', r.status);
  if(!r.ok) throw new Error('CSV not found '+r.status);
  const t = (await r.text()).replace(/^\uFEFF|\u0000/g,'').trim();
  const lines = t? t.split(/\r?\n/) : [];
  if(!lines.length) return [];
  const header = splitCsvLine(lines.shift()).map(s=>s.toLowerCase());
  log('CSV header:', header.join(','));
  const idx = Object.fromEntries(header.map((h,i)=>[h,i]));
  return lines.filter(Boolean).map(line=>{
    const c=splitCsvLine(line);
    return {
      id:(c[idx['id']]??'').trim(),
      url:(c[idx['url']]??'').trim(),
      type:(c[idx['type']]??'').trim().toLowerCase(),
      tags:(c[idx['tags']]??'').trim(),
      notes:(c[idx['notes']]??'').trim()
    };
  });
}

/* ==== WEKO URL 正規化 ==== */
function normalizeWekoUrl(id,url){
  if (isHttp(url) && isWekoUrl(url)) return url;
  const idFromUrl = (()=>{ if(/^\d+$/.test(url)) return url; const m=/\/records?\/(\d+)/.exec(url||''); if(m) return m[1]; if(/^records?\/(\d+)/.test(url||'')) return RegExp.$1; return ''; })();
  const recid = idFromUrl || (/^\d+$/.test(id||'')?id:'');
  return recid ? `https://${REPO_HOST}/records/${recid}` : '';
}

/* ==== メタ生成（DOI/WEKO） ==== */
async function fetchMetaDOI(doi){
  const steps = [
    ['crossref','https://api.crossref.org/works/'+encodeURIComponent(doi), {'Accept':'application/json'}, j=>({title:j.message?.title?.[0]||'',year:j.message?.issued?.['date-parts']?.[0]?.[0]||j.message?.created?.['date-parts']?.[0]?.[0]||'',authors:(j.message?.author||[]).map(a=>[a.given,a.family].filter(Boolean).join(' ')).join(', '),journal:j.message?.['container-title']?.[0]||''})],
    ['doi.org-csl','https://doi.org/'+encodeURIComponent(doi), {'Accept':'application/vnd.citationstyles.csl+json'}, j=>({title:Array.isArray(j.title)?j.title[0]:(j.title||''),year:j.issued?.['date-parts']?.[0]?.[0]||'',authors:(j.author||[]).map(a=>a.family||a.given?[a.given,a.family].filter(Boolean).join(' '):(a.name||'')).join(', '),journal:Array.isArray(j['container-title'])?j['container-title'][0]:(j['container-title']||j['container-title-short']||'')})],
    ['datacite','https://api.datacite.org/dois/'+encodeURIComponent(doi), {'Accept':'application/json'}, j=>{const a=j.data?.attributes||{}; return {title:a.titles?.[0]?.title||'',year:a.publicationYear||'',authors:(a.creators||a.contributors||[]).map(p=>[p.givenName,p.familyName,p.name].filter(Boolean)[0]||'').filter(Boolean).join(', '),journal:(a.container?.title)||a.publisher||''};}],
    ['openalex','https://api.openalex.org/works/https://doi.org/'+encodeURIComponent(doi), {'Accept':'application/json'}, j=>({title:j.title||'',year:j.publication_year||(j.from_publication_date||'').slice(0,4)||'',authors:(j.authorships||[]).map(x=>x.author?.display_name).filter(Boolean).join(', '),journal:j.host_venue?.display_name||j.primary_location?.source?.display_name||''})]
  ];
  for (const [src,u,h,shape] of steps){
    try{ const r=await fetch(u,{headers:h,cache:'no-store'}); if(r.ok){ const json=await r.json(); return {source:src, meta:shape(json)}; } }catch{}
  }
  return {source:'none', meta:{title:'',year:'',authors:'',journal:''}};
}
async function fetchMetaWEKO(absUrl){
  if (!absUrl) return {source:'weko-json-fail', meta:{title:'',authors:'',year:'',journal:''}, edu:false};
  try{
    const u = new URL(absUrl);
    const m = /\/records?\/(\d+)/.exec(u.pathname); if(!m) return {source:'weko-json-fail', meta:{}, edu:false};
    const jsonUrl = `${u.protocol}//${u.host}/records/${m[1]}/export/json`;
    const r = await fetch(jsonUrl,{cache:'no-store'}); if(!r.ok) throw new Error('status '+r.status);
    const j = await r.json(); const md = j.metadata||{};
    const title = ([
      md.item_title,
      md.item_titles?.attribute_value_mlt?.[0]?.subitem_title,
      Array.isArray(j.title)?j.title[0]:j.title,
      md.title
    ].find(Boolean)||'').toString();
    const creators = md.item_creator?.attribute_value_mlt || md.creators || [];
    const names=[]; creators.forEach(c=>{ if(Array.isArray(c.creatorNames)) c.creatorNames.forEach(n=>n?.creatorName&&names.push(n.creatorName)); else if(c.creatorName) names.push(c.creatorName); else if(typeof c.name==='string') names.push(c.name); });
    const authors = names.filter(Boolean).join(', ');
    const bib = md.item_10002_biblio_info_7?.attribute_value_mlt?.[0] || {};
    const issued = bib.bibliographicIssueDates?.bibliographicIssueDate || md.publish_date || md.pubdate?.attribute_value || '';
    const year = (issued||'').toString().slice(0,4);
    const journal = (bib.bibliographic_titles?.[0]?.bibliographic_title) || '';
    const sets = md._oai?.sets || j.metadata?._oai?.sets || [];
    const eduHit = Array.isArray(sets) && sets.some(s=>(s||'').startsWith(EDU_SET_PREFIX));
    return {source:'weko-json', meta:{title,authors,year,journal}, edu:eduHit};
  }catch(e){
    return {source:'weko-json-fail', meta:{title:'',authors:'',year:'',journal:''}, edu:false};
  }
}

/* ==== 表示 ==== */
function passFilter(item, q, eduOnly){
  if (eduOnly && !item.edu) return false;
  if (!q) return true;
  const kw = Array.isArray(item.keywords) ? item.keywords.join(' ') : '';
  return [item.meta.title, item.meta.authors, item.meta.journal, item.display, item.tags, item.notes, kw]
    .some(v => (v||'').toString().toLowerCase().includes(q));
}
function sortBy(items,mode){ const byYear=(a,b)=>(b.meta.year||0)-(a.meta.year||0); const byTitle=(a,b)=>(a.meta.title||'').localeCompare(b.meta.title||''); if(mode==='year-asc') return items.sort((a,b)=>-byYear(a,b)); if(mode==='title-asc') return items.sort(byTitle); if(mode==='title-desc') return items.sort((a,b)=>-byTitle(a,b)); return items.sort(byYear); }
let records=[];

function render(){
  const q=norm(document.getElementById('q').value);
  const mode=document.getElementById('sort').value;
  const eduOnly=document.getElementById('eduOnly').checked;
  const arr = sortBy(records.filter(r=>passFilter(r,q,eduOnly)),mode);
  const html = arr.map(r=>{
    const year=r.meta.year?` (${r.meta.year})`:'';
    const tags=(r.tags||'').split(';').map(s=>s.trim()).filter(Boolean).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join(' ');
    const kwChips = (Array.isArray(r.keywords)?r.keywords:[]).slice(0,12).map(k=>`<span class="kw">${escapeHtml(k)}</span>`).join(' ');
    const notes=r.notes?`<div class="muted">📝 ${escapeHtml(r.notes)}</div>`:'';
    const journal=r.meta.journal?`<span class="muted"> — ${escapeHtml(r.meta.journal)}</span>`:'';
    const title=escapeHtml(r.meta.title||r.display);
    const authors=escapeHtml(r.meta.authors||'');
    const src=r.source?`<span class="pill muted">${r.source}</span>`:'';
    const edu=r.edu?`<span class="pill">教育</span>`:'';
    const href=r.link||'javascript:void(0)'; const cls=r.link?'':'dead';
    const warn=(!r.link)?`<span class="pill warn">リンク不明</span>`:'';
    return `<div class="card">
      <div><a class="${cls}" href="${href}" target="${r.link?'_blank':''}" rel="noopener"><strong>${title}</strong></a>${year}${journal} ${warn}</div>
      <div class="muted">${authors}</div>
      <div class="row" style="margin:.4rem 0">${tags} ${kwChips} ${edu}</div>
      ${notes}
      <div class="row" style="margin-top:.6rem;gap:8px;align-items:center">
        ${src}
        <code class="pill">${escapeHtml(r.display)}</code>
      </div>
    </div>`;
  }).join('');
  document.getElementById('list').innerHTML = html || `<div class="muted">該当なし</div>`;
  document.getElementById('count').textContent = `${arr.length} 件`;
}

/* ==== 起動：cache → csv（fallback） ==== */
async function boot(){
  // 1) cache を試す
  try{
    const r = await fetch(CACHE_URL+'?t='+Date.now(), {cache:'no-store'});
    log('try cache:', r.status);
    if (r.ok){
      const cache = await r.json();
      if (Array.isArray(cache) && cache.length){
        records = cache;
        render();
        return;
      }
    }
  }catch(e){ log('cache error', String(e)); }

  // 2) csv から（CORSでタイトル取れない場合もURL名で表示）
  try{
    const rows = await fetchCsv(CSV_URL+'?t='+Date.now());
    const built=[];
    for (const row of rows){
      const type = row.type || (isDOI(row.id)||isDOI(row.url)?'doi':(isWekoUrl(row.url)?'weko':'url'));
      if (type==='doi'){
        const doi = row.id && isDOI(row.id) ? row.id : (row.url||'').replace(/^https?:\/\/doi\.org\//i,'');
        const m = await fetchMetaDOI(doi);
        built.push({link:'https://doi.org/'+encodeURIComponent(doi), display:doi, tags:row.tags, notes:row.notes, source:m.source, meta:m.meta, edu:false});
      }else if (type==='weko'){
        const abs = normalizeWekoUrl(row.id,row.url);
        const meta = await fetchMetaWEKO(abs); // CORSなら weko-json-fail
        built.push({link:abs, display:abs||row.url||row.id, tags:row.tags, notes:row.notes, source:meta.source, meta:meta.meta, edu:meta.edu});
      }else{
        built.push({link:isHttp(row.url)?row.url:'', display:row.url||row.id, tags:row.tags, notes:row.notes, source:'url', meta:{title:'',authors:'',year:'',journal:''}, edu:false});
      }
    }
    records = built;
    render();
  }catch(e){
    document.getElementById('list').innerHTML = `<div class="muted">読込エラー: ${escapeHtml(String(e))}</div>`;
  }
}
boot();
</script>
</body>
</html>
