<!doctype html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DOIリンク集</title>
<style>
  :root{--gap:14px}
  body{font-family:system-ui,"Noto Sans JP",sans-serif;margin:24px}
  header{display:flex;flex-wrap:wrap;gap:var(--gap);align-items:center;margin-bottom:var(--gap)}
  input,select,button{padding:.6rem .7rem;font-size:16px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:var(--gap)}
  .card{border:1px solid #e5e7eb;border-radius:14px;padding:16px}
  .muted{color:#6b7280;font-size:0.9em}
  .warn{color:#b45309}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .tag{background:#eef2ff;border:1px solid #e0e7ff;border-radius:999px;padding:.1rem .6rem;font-size:.85em}
  a{color:#1f6feb;text-decoration:none}
  a:hover{text-decoration:underline}
  .pill{border:1px solid #e5e7eb;border-radius:999px;padding:.3rem .6rem;display:inline-block}
  .right{margin-left:auto}
  .btn{cursor:pointer;background:#fff}
  footer{margin-top:28px;color:#6b7280;font-size:.9em}
</style>
</head>
<body>
<header>
  <input id="q" placeholder="タイトル / 著者 / 雑誌 / DOI / タグで検索" oninput="render()" />
  <select id="sort" onchange="render()">
    <option value="year-desc">新しい順</option>
    <option value="year-asc">古い順</option>
    <option value="title-asc">タイトルA→Z</option>
    <option value="title-desc">タイトルZ→A</option>
  </select>
  <span id="count" class="pill"></span>
  <span class="right muted">更新は <code>dois.csv</code> を編集（任意: <code>bibtex</code> 列）</span>
</header>

<div id="list" class="grid"><div class="muted">読み込み中…</div></div>

<footer>Powered by <a href="https://www.jstage.jst.go.jp/browse/-char/ja" target="_blank" rel="noopener">J-STAGE</a> / Crossref / DataCite / OpenAlex / doi.org</footer>

<script>
const DATA_SRC = (()=>{const u=new URL('dois.csv',location.href);u.searchParams.set('t',Date.now());return u.href})();
const META_JSON = (()=>{const u=new URL('meta.json',location.href);u.searchParams.set('t',Date.now());return u.href})();

const norm = s => (s||'').toString().toLowerCase();
const escapeHtml = s => (s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
function splitCsvLine(line){const re=/("([^"]|"")*"|[^,]+)/g;const out=[];let m;while((m=re.exec(line))!==null)out.push(m[0].replace(/^"(.*)"$/,'$1').replace(/""/g,'"'));return out.map(s=>s.trim())}

async function fetchCsv(url){
  const res=await fetch(url,{cache:'no-store'}); if(!res.ok) throw new Error('CSV not found');
  const text=await res.text(); const lines=text.replace(/^\uFEFF/,'').trim().split(/\r?\n/); if(!lines.length) return [];
  const header=splitCsvLine(lines.shift()).map(s=>s.replace(/^\uFEFF/,'').trim().toLowerCase());
  const idx=Object.fromEntries(header.map((h,i)=>[h,i]));
  return lines.filter(Boolean).map(line=>{const c=splitCsvLine(line);return{
    doi:(c[idx['doi']]??'').trim(), tags:(c[idx['tags']]??'').trim(), notes:(c[idx['notes']]??'').trim(), bibtex:(c[idx['bibtex']]??'').trim()
  }}).filter(r=>r.doi);
}

/* ---- precomputed meta (GitHub Actions 生成) を最優先 ---- */
let preMeta = {};
async function loadPreMeta(){
  try{ const r=await fetch(META_JSON,{cache:'no-store'}); if(r.ok){ preMeta = await r.json(); } }catch{}
}

/* ---- APIチェーン ---- */
async function fetchMeta(doi){
  const key='meta_'+doi; const cached=localStorage.getItem(key); if(cached){try{return JSON.parse(cached)}catch{}}
  // Crossref
  try{let r=await fetch('https://api.crossref.org/works/'+encodeURIComponent(doi)); if(r.ok){const j=await r.json(); const out={source:'crossref',raw:j}; localStorage.setItem(key,JSON.stringify(out)); return out}}catch{}
  // doi.org CSL
  try{let r=await fetch('https://doi.org/'+encodeURIComponent(doi),{headers:{Accept:'application/vnd.citationstyles.csl+json'}}); if(r.ok){const j=await r.json(); const out={source:'doi.org-csl',raw:j}; localStorage.setItem(key,JSON.stringify(out)); return out}}catch{}
  // doi.org citeproc
  try{let r=await fetch('https://doi.org/'+encodeURIComponent(doi),{headers:{Accept:'application/citeproc+json'}}); if(r.ok){const j=await r.json(); const out={source:'doi.org-citeproc',raw:j}; localStorage.setItem(key,JSON.stringify(out)); return out}}catch{}
  // DataCite
  try{let r=await fetch('https://api.datacite.org/dois/'+encodeURIComponent(doi)); if(r.ok){const j=await r.json(); const out={source:'datacite',raw:j}; localStorage.setItem(key,JSON.stringify(out)); return out}}catch{}
  // OpenAlex
  try{let r=await fetch('https://api.openalex.org/works/https://doi.org/'+encodeURIComponent(doi)); if(r.ok){const j=await r.json(); const out={source:'openalex',raw:j}; localStorage.setItem(key,JSON.stringify(out)); return out}}catch{}
  // J-STAGE WebAPI（号の目次から推定）
  try{ const j=await fetchJstageByDoi(doi); if(j){localStorage.setItem(key,JSON.stringify(j)); return j} }catch{}
  const out={source:'none',raw:null}; localStorage.setItem(key,JSON.stringify(out)); return out;
}
function toCite(meta){
  const {source,raw}=meta||{}; if(!raw) return {title:'',authors:'',year:'',journal:''};
  if(source==='crossref'){const m=raw.message||{};return{title:(m.title&&m.title[0])||'',authors:(m.author||[]).map(a=>[a.given,a.family].filter(Boolean).join(' ')).join(', '),year:(m.created?.['date-parts']?.[0]?.[0])||(m.issued?.['date-parts']?.[0]?.[0])||'',journal:(m['container-title']&&m['container-title'][0])||''}}
  if(source==='doi.org-csl'||source==='doi.org-citeproc'){const m=raw||{};return{title:Array.isArray(m.title)?m.title[0]:(m.title||''),authors:(m.author||[]).map(a=>a.family||a.given?[a.given,a.family].filter(Boolean).join(' '):(a.name||'')).join(', '),year:(m.issued?.['date-parts']?.[0]?.[0])||'',journal:Array.isArray(m['container-title'])?m['container-title'][0]:(m['container-title']||m['container-title-short']||'')}}
  if(source==='datacite'){const a=raw.data?.attributes||{};return{title:(a.titles&&a.titles[0]?.title)||'',authors:(a.creators||a.contributors||[]).map(p=>[p.givenName,p.familyName,p.name].filter(Boolean)[0]||'').filter(Boolean).join(', '),year:a.publicationYear||'',journal:(a.container&&a.container.title)||a.publisher||''}}
  if(source==='openalex'){const m=raw||{};return{title:m.title||'',authors:(m.authorships||[]).map(x=>x.author?.display_name).filter(Boolean).join(', '),year:m.publication_year||(m.from_publication_date||'').slice(0,4)||'',journal:m.host_venue?.display_name||m.primary_location?.source?.display_name||''}}
  if(source==='jstage-webapi'){return{title:raw.title||'',authors:raw.authors||'',year:raw.year||'',journal:raw.journal||''}}
  return{title:'',authors:'',year:'',journal:''}
}

/* J-STAGE API補助 */
function parseJstageDoi(doi){
  const m=/^10\.57294\/([^.]+)\.(\d+)\.(\d+)_([\dA-Za-z]+)$/.exec(doi);
  return m?{cdjournal:m[1],vol:m[2],no:m[3],start:m[4]}:null;
}
async function fetchJstageByDoi(doi){
  const p=parseJstageDoi(doi); if(!p) return null;
  const u=new URL('https://api.jstage.jst.go.jp/searchapi/do'); u.searchParams.set('service','3'); u.searchParams.set('cdjournal',p.cdjournal); u.searchParams.set('vol',p.vol); u.searchParams.set('no',p.no); u.searchParams.set('count','200');
  const r=await fetch(u); if(!r.ok) return null; const xml=await r.text(); const doc=new DOMParser().parseFromString(xml,'application/xml');
  const hit=[...doc.getElementsByTagName('entry')].find(e=>{
    const d=e.getElementsByTagName('prism:doi')[0]?.textContent?.trim(); const sp=e.getElementsByTagName('prism:startingPage')[0]?.textContent?.trim();
    return (d && d.toLowerCase()===doi.toLowerCase()) || (sp && sp===p.start);
  });
  if(!hit) return null;
  const tJa=hit.querySelector('article_title > ja')?.textContent?.trim(); const tEn=hit.querySelector('article_title > en')?.textContent?.trim();
  const aJa=[...hit.querySelectorAll('author > ja')].map(n=>n.textContent.trim()); const aEn=[...hit.querySelectorAll('author > en')].map(n=>n.textContent.trim());
  const year=hit.getElementsByTagName('pubyear')[0]?.textContent?.slice(0,4)||''; const journal=hit.querySelector('material_title > ja')?.textContent?.trim()||hit.querySelector('material_title > en')?.textContent?.trim()||'';
  return {source:'jstage-webapi',raw:{title:tJa||tEn||'',authors:(aJa.length?aJa:aEn).join(', '),year,journal}};
}

/* --- BibTeX保存ボタンのみ（取得はActions側でやる） --- */
async function downloadBibtexUTF8(doiEnc){
  const doi=decodeURIComponent(doiEnc);
  // 利用者操作で一般的な経路（CrossCite/doi.org）だけ残す
  const tryUrls=[
    'https://citation.crosscite.org/format?doi='+encodeURIComponent(doi)+'&style=bibtex',
    'https://doi.org/'+encodeURIComponent(doi)
  ];
  for(const u of tryUrls){
    try{const h=u.includes('doi.org')?{Accept:'application/x-bibtex'}:{Accept:'text/plain'}; const r=await fetch(u,{headers:h}); if(r.ok){const t=await r.text(); const blob=new Blob(["\uFEFF"+t],{type:'text/plain;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=(doi.replace(/[^\w.-]+/g,'_'))+'.bib'; document.body.appendChild(a); a.click(); a.remove(); return;}}catch{}
  }
  alert('BibTeXの取得に失敗しました（CrossCite/doi.org）。');
}

/* ---- アプリ本体 ---- */
let records=[], rows=[];
function passFilter(item,q){if(!q)return true;return [item.meta.title,item.meta.authors,item.meta.journal,item.doi,item.tags,item.notes].some(v=>norm(v).includes(q))}
function sortBy(items,mode){const byYear=(a,b)=>(b.meta.year||0)-(a.meta.year||0);const byTitle=(a,b)=>(a.meta.title||'').localeCompare(b.meta.title||'');if(mode==='year-asc')return items.sort((a,b)=>-byYear(a,b));if(mode==='title-asc')return items.sort(byTitle);if(mode==='title-desc')return items.sort((a,b)=>-byTitle(a,b));return items.sort(byYear)}
async function getFinalMeta(row){
  const pm=preMeta[row.doi]; if(pm) return {source:pm.source||'precomputed', meta:{title:pm.title||'',authors:pm.authors||'',year:pm.year||'',journal:pm.journal||''}};
  const m=await fetchMeta(row.doi); let cite=toCite(m); let src=m.source;
  if(!cite.title){ /* 最後の砦：CrossCite/doi.orgのBibTeXから抽出（クライアント許容ドメインのみ） */
    const text=await (async()=>{for (const u of ['https://citation.crosscite.org/format?doi='+encodeURIComponent(row.doi)+'&style=bibtex','https://doi.org/'+encodeURIComponent(row.doi)]){try{const h=u.includes('doi.org')?{Accept:'application/x-bibtex'}:{Accept:'text/plain'}; const r=await fetch(u,{headers:h}); if(r.ok) return await r.text();}catch{}} return ''})();
    if(text){ const bib=parseBibtex(text); cite={title:cite.title||bib.title,authors:cite.authors||bib.authors,year:cite.year||bib.year,journal:cite.journal||bib.journal}; if(bib.title) src=(src?src+'+':'')+'bibtex'; }
  }
  return {source:src,meta:cite};
}
function parseBibtex(text){
  const read=(name)=>{const re=new RegExp('\\b'+name+'\\s*=\\s*(\\{(?:[^{}]|\\{[^{}]*\\})*\\}|"[^"]*")','is');const m=re.exec(text);if(!m)return'';let v=m[1].trim();if(v.startsWith('{')&&v.endsWith('}'))v=v.slice(1,-1);if(v.startsWith('"')&&v.endsWith('"'))v=v.slice(1,-1);v=v.replace(/\s+/g,' ').trim();while(v.startsWith('{')&&v.endsWith('}')){const inner=v.slice(1,-1).trim();let d=0,ok=true;for(const c of inner){if(c==='{')d++;else if(c==='}')d--;if(d<0){ok=false;break}}if(!ok||d!==0)break;v=inner}return v}
  const splitAuthors=s=>s?s.split(/\s+and\s+/i).map(t=>{t=t.trim();if(t.includes(',')){const [l,f]=t.split(',').map(x=>x.trim());return [f,l].filter(Boolean).join(' ')}return t}).join(', '):'';
  const title=read('title'), authors=splitAuthors(read('author')); let year=read('year')||read('date'); const m=year.match(/\b(19|20)\d{2}\b/); year=m?m[0]:''; const journal=read('journal')||read('booktitle'); return {title,authors,year,journal};
}
async function boot(){
  try{
    await loadPreMeta();
    rows=await fetchCsv(DATA_SRC);
    const slot=8,out=[];
    for(let i=0;i<rows.length;i+=slot){
      const batch=rows.slice(i,i+slot).map(async r=>{const fin=await getFinalMeta(r);return{doi:r.doi,tags:r.tags||'',notes:r.notes||'',meta:fin.meta,source:fin.source}});
      out.push(...await Promise.all(batch));
    }
    records=out; render();
  }catch(e){document.getElementById('list').innerHTML='<div class="muted">読込エラー: '+escapeHtml(String(e))+'</div>'}
}
function render(){
  const q=norm(document.getElementById('q').value),mode=document.getElementById('sort').value,target=document.getElementById('list');
  const arr=sortBy(records.filter(r=>passFilter(r,q)),mode);
  target.innerHTML=arr.map(r=>{
    const y=r.meta.year?` (${r.meta.year})`:''; const tags=(r.tags||'').split(';').map(s=>s.trim()).filter(Boolean).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join(' ');
    const notes=r.notes?`<div class="muted">📝 ${escapeHtml(r.notes)}</div>`:''; const j=r.meta.journal?`<span class="muted"> — ${escapeHtml(r.meta.journal)}</span>`:'';
    const title=escapeHtml(r.meta.title||r.doi); const authors=escapeHtml(r.meta.authors||''); const src=r.source?`<span class="pill muted">${r.source}</span>`:'';
    return `<div class="card">
      <div><a href="https://doi.org/${encodeURIComponent(r.doi)}" target="_blank" rel="noopener"><strong>${title}</strong></a>${y}${j} ${r.meta.title?'':`<span class="pill warn">未取得</span>`}</div>
      <div class="muted">${authors}</div>
      <div class="row" style="margin:.4rem 0">${tags}</div>
      ${notes}
      <div class="row" style="margin-top:.6rem;align-items:center;gap:8px">
        <button class="pill btn" onclick="downloadBibtexUTF8('${encodeURIComponent(r.doi)}')">BibTeX（UTF-8保存）</button>
        ${src}<code class="pill">${escapeHtml(r.doi)}</code>
      </div>
    </div>`;
  }).join('');
  document.getElementById('count').textContent=`${arr.length} 件`;
}
boot();
</script>
</body>
</html>
