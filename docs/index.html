<!doctype html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DOIãƒªãƒ³ã‚¯é›†</title>
<style>
  :root{--gap:14px}
  body{font-family:system-ui,"Noto Sans JP",sans-serif;margin:24px}
  header{display:flex;flex-wrap:wrap;gap:var(--gap);align-items:center;margin-bottom:var(--gap)}
  input,select,button{padding:.6rem .7rem;font-size:16px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:var(--gap)}
  .card{border:1px solid #e5e7eb;border-radius:14px;padding:16px}
  .muted{color:#6b7280;font-size:0.9em}
  .warn{color:#b45309}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .tag{background:#eef2ff;border:1px solid #e0e7ff;border-radius:999px;padding:.1rem .6rem;font-size:.85em}
  a{color:#1f6feb;text-decoration:none}
  a:hover{text-decoration:underline}
  .pill{border:1px solid #e5e7eb;border-radius:999px;padding:.3rem .6rem;display:inline-block}
  .right{margin-left:auto}
  .btn{cursor:pointer;background:#fff}
  .btn:disabled{opacity:.6;cursor:not-allowed}
</style>
</head>
<body>
<header>
  <input id="q" placeholder="ã‚¿ã‚¤ãƒˆãƒ« / è‘—è€… / é›‘èªŒ / DOI / ã‚¿ã‚°ã§æ¤œç´¢" oninput="render()" />
  <select id="sort" onchange="render()">
    <option value="year-desc">æ–°ã—ã„é †</option>
    <option value="year-asc">å¤ã„é †</option>
    <option value="title-asc">ã‚¿ã‚¤ãƒˆãƒ«Aâ†’Z</option>
    <option value="title-desc">ã‚¿ã‚¤ãƒˆãƒ«Zâ†’A</option>
  </select>
  <span id="count" class="pill"></span>
  <span class="right muted">æ›´æ–°ã¯ <code>dois.csv</code> ã‚’ç·¨é›†ã—ã¦ã‚³ãƒŸãƒƒãƒˆ</span>
</header>

<div id="list" class="grid">
  <div class="muted">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
</div>

<script>
/** â–¼ CSVï¼ˆåŒéšå±¤ã® dois.csvï¼‰ */
const DATA_SRC = (() => { const u=new URL('dois.csv', location.href); u.searchParams.set('t', Date.now()); return u.href; })();

/** â–¼ util */
const norm = s => (s||'').toString().toLowerCase();
const escapeHtml = s => (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
function splitCsvLine(line){ const re=/("([^"]|"")*"|[^,]+)/g; const out=[]; let m; while((m=re.exec(line))!==null) out.push(m[0].replace(/^"(.*)"$/,'$1').replace(/""/g,'"')); return out.map(s=>s.trim()); }
async function fetchCsv(url){
  const res = await fetch(url, {cache:'no-store'});
  if (!res.ok) throw new Error('CSV not found: ' + res.status);
  const text = await res.text();
  const lines = text.replace(/^\uFEFF/, '').trim().split(/\r?\n/);
  if (!lines.length) return [];
  const header = splitCsvLine(lines.shift()).map(s=>s.replace(/^\uFEFF/, '').trim().toLowerCase());
  const idx = Object.fromEntries(header.map((h,i)=>[h,i]));
  return lines.filter(Boolean).map(line=>{
    const cells = splitCsvLine(line);
    return { doi:(cells[idx['doi']]??'').trim(), tags:(cells[idx['tags']]??'').trim(), notes:(cells[idx['notes']]??'').trim() };
  }).filter(r=>r.doi);
}

/** â–¼ æ—¢å­˜ãƒ¡ã‚¿å–å¾—ï¼ˆCrossrefâ†’doi.org CSLâ†’citeprocâ†’DataCiteâ†’OpenAlexï¼‰ */
async function fetchMeta(doi){
  const key = 'meta_' + doi;
  const cached = localStorage.getItem(key);
  if (cached) { try { return JSON.parse(cached); } catch {} }

  // Crossref
  try{ const r=await fetch('https://api.crossref.org/works/'+encodeURIComponent(doi),{headers:{'Accept':'application/json'}}); if(r.ok){ const json=await r.json(); const out={source:'crossref',raw:json}; localStorage.setItem(key,JSON.stringify(out)); return out; } }catch{}
  // doi.org CSL
  try{ const r=await fetch('https://doi.org/'+encodeURIComponent(doi),{headers:{'Accept':'application/vnd.citationstyles.csl+json'}}); if(r.ok){ const json=await r.json(); const out={source:'doi.org-csl',raw:json}; localStorage.setItem(key,JSON.stringify(out)); return out; } }catch{}
  // doi.org citeproc+json
  try{ const r=await fetch('https://doi.org/'+encodeURIComponent(doi),{headers:{'Accept':'application/citeproc+json'}}); if(r.ok){ const json=await r.json(); const out={source:'doi.org-citeproc',raw:json}; localStorage.setItem(key,JSON.stringify(out)); return out; } }catch{}
  // DataCite
  try{ const r=await fetch('https://api.datacite.org/dois/'+encodeURIComponent(doi),{headers:{'Accept':'application/json'}}); if(r.ok){ const json=await r.json(); const out={source:'datacite',raw:json}; localStorage.setItem(key,JSON.stringify(out)); return out; } }catch{}
  // OpenAlex
  try{ const r=await fetch('https://api.openalex.org/works/https://doi.org/'+encodeURIComponent(doi),{headers:{'Accept':'application/json'}}); if(r.ok){ const json=await r.json(); const out={source:'openalex',raw:json}; localStorage.setItem(key,JSON.stringify(out)); return out; } }catch{}

  // â˜… J-STAGE WebAPI ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆJaLC/J-STAGE DOI ã‚’æ¨å®šï¼‰
  try{
    const j = await fetchJstageByDoi(doi); // {raw, source:'jstage-webapi'}
    if (j) { localStorage.setItem(key, JSON.stringify(j)); return j; }
  }catch{}

  const out={source:'none',raw:null}; localStorage.setItem(key,JSON.stringify(out)); return out;
}

/** â–¼ J-STAGE DOI ãªã‚‰ WebAPI ã§å–å¾—ï¼ˆXMLâ†’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰ */
function parseJstageDoi(doi){
  // ä¾‹: 10.57294/jaed.3.0_11  -> {prefix:10.57294, cdjournal:jaed, vol:3, no:0, start:11}
  const m = /^10\.57294\/([^.]+)\.(\d+)\.(\d+)_([\dA-Za-z]+)$/.exec(doi);
  if (!m) return null;
  return { cdjournal:m[1], vol: m[2], no: m[3], start: m[4] };
}
async function fetchJstageByDoi(doi){
  const p = parseJstageDoi(doi);
  if (!p) return null;
  const url = new URL('https://api.jstage.jst.go.jp/searchapi/do');
  url.searchParams.set('service','3'); // è«–æ–‡æ¤œç´¢çµæœå–å¾—
  url.searchParams.set('cdjournal', p.cdjournal);
  url.searchParams.set('vol', p.vol);
  url.searchParams.set('no', p.no);
  url.searchParams.set('count','200'); // å·å†…æœ€å¤§ä»¶æ•°æƒ³å®š
  const res = await fetch(url.href, { cache:'no-store' });
  if (!res.ok) return null;
  const xmlText = await res.text();
  const doc = new DOMParser().parseFromString(xmlText, 'application/xml');
  const entries = [...doc.getElementsByTagName('entry')];
  // DOIä¸€è‡´ or é–‹å§‹ãƒšãƒ¼ã‚¸ä¸€è‡´ã§ç‰¹å®š
  const hit = entries.find(e=>{
    const doiNode = e.getElementsByTagName('prism:doi')[0];
    const spNode  = e.getElementsByTagName('prism:startingPage')[0];
    const doiVal  = doiNode?.textContent?.trim();
    const spVal   = spNode?.textContent?.trim();
    return (doiVal && doiVal.toLowerCase()===doi.toLowerCase()) || (spVal && spVal===p.start);
  });
  if (!hit) return null;
  // ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆjaå„ªå…ˆâ†’enï¼‰
  const tJa = hit.querySelector('article_title > ja')?.textContent?.trim();
  const tEn = hit.querySelector('article_title > en')?.textContent?.trim();
  const title = tJa || tEn || '';
  // è‘—è€…åï¼ˆja / enï¼‰
  const aJa = [...hit.querySelectorAll('author > ja')].map(n=>n.textContent.trim()).filter(Boolean);
  const aEn = [...hit.querySelectorAll('author > en')].map(n=>n.textContent.trim()).filter(Boolean);
  const authors = (aJa.length ? aJa : aEn).join(', ');
  // èªŒå
  const mj = hit.querySelector('material_title > ja')?.textContent?.trim()
           || hit.querySelector('material_title > en')?.textContent?.trim() || '';
  const year = hit.getElementsByTagName('pubyear')[0]?.textContent?.slice(0,4) || '';
  const out = { source:'jstage-webapi', raw:{
    title, authors, journal:mj, year
  }};
  return out;
}

/** â–¼ ã‚½ãƒ¼ã‚¹åˆ¥ã«çµ±ä¸€æ•´å½¢ */
function toCite(meta){
  const { source, raw } = meta || {};
  if (!raw) return { title: '(å–å¾—å¤±æ•—)', year: '', authors: '', journal: '' };

  if (source==='crossref'){
    const m = raw.message||{};
    return {
      title:(m.title&&m.title[0])||'',
      year:(m.created?.['date-parts']?.[0]?.[0])||(m.issued?.['date-parts']?.[0]?.[0])||'',
      authors:(m.author||[]).map(a=>[a.given,a.family].filter(Boolean).join(' ')).join(', '),
      journal:(m['container-title']&&m['container-title'][0])||''
    };
  }
  if (source==='doi.org-csl' || source==='doi.org-citeproc'){
    const m = raw||{};
    const year=(m.issued?.['date-parts']?.[0]?.[0])||'';
    const authors=(m.author||[]).map(a=>a.family||a.given?[a.given,a.family].filter(Boolean).join(' '):(a.name||'')).join(', ');
    return { title:Array.isArray(m.title)?m.title[0]:(m.title||''), year,
      authors, journal:Array.isArray(m['container-title'])?m['container-title'][0]:(m['container-title']||m['container-title-short']||'') };
  }
  if (source==='datacite'){
    const a = raw.data?.attributes||{};
    const title=(a.titles&&a.titles[0]?.title)||'';
    const authors=(a.creators||a.contributors||[]).map(p=>[p.givenName,p.familyName,p.name].filter(Boolean)[0]||'').filter(Boolean).join(', ');
    const journal=(a.container && a.container['title']) || (a.publisher||'');
    return { title, year:a.publicationYear||'', authors, journal };
  }
  if (source==='openalex'){
    const m=raw||{};
    const year=m.publication_year||(m.from_publication_date||'').slice(0,4)||'';
    const authors=(m.authorships||[]).map(x=>x.author?.display_name).filter(Boolean).join(', ');
    const journal=m.host_venue?.display_name||m.primary_location?.source?.display_name||'';
    return { title:m.title||'', year, authors, journal };
  }
  if (source==='jstage-webapi'){
    return { title: raw.title||'', year: raw.year||'', authors: raw.authors||'', journal: raw.journal||'' };
  }
  return { title:'(å–å¾—å¤±æ•—)', year:'', authors:'', journal:'' };
}

/** â–¼ ãƒ•ã‚£ãƒ«ã‚¿ï¼†ã‚½ãƒ¼ãƒˆï¼çŠ¶æ…‹ */
function passFilter(item, q){ if (!q) return true;
  return [item.meta.title, item.meta.authors, item.meta.journal, item.doi, item.tags, item.notes].some(v=>norm(v).includes(q));
}
function sortBy(items, mode){
  const byYear=(a,b)=>(b.meta.year||0)-(a.meta.year||0);
  const byTitle=(a,b)=>(a.meta.title||'').localeCompare(b.meta.title||'');
  if (mode==='year-asc') return items.sort((a,b)=>-byYear(a,b));
  if (mode==='title-asc') return items.sort(byTitle);
  if (mode==='title-desc') return items.sort((a,b)=>-byTitle(a,b));
  return items.sort(byYear);
}
let records=[];

/** â–¼ èµ·å‹• */
async function boot(){
  try{
    const rows = await fetchCsv(DATA_SRC);
    const slot=6, out=[];
    for (let i=0;i<rows.length;i+=slot){
      const batch = rows.slice(i,i+slot).map(async r=>{
        const meta = await fetchMeta(r.doi);
        const cite = toCite(meta);
        return { doi:r.doi, tags:r.tags||'', notes:r.notes||'', meta:cite, source:meta.source };
      });
      out.push(...await Promise.all(batch));
    }
    records = out;
    render();
  }catch(err){
    console.error(err);
    document.getElementById('list').innerHTML = `<div class="muted">èª­è¾¼ã‚¨ãƒ©ãƒ¼: ${escapeHtml(String(err))}</div>`;
  }
}

/** â–¼ æç”» */
function render(){
  const q=norm(document.getElementById('q').value);
  const mode=document.getElementById('sort').value;
  const target=document.getElementById('list');
  const arr=sortBy(records.filter(r=>passFilter(r,q)),mode);

  target.innerHTML = arr.map(r=>{
    const doiUrl='https://doi.org/'+encodeURIComponent(r.doi);
    const year=r.meta.year?` (${r.meta.year})`:'';
    const tags=(r.tags||'').split(';').map(s=>s.trim()).filter(Boolean).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join(' ');
    const notes=r.notes?`<div class="muted">ğŸ“ ${escapeHtml(r.notes)}</div>`:'';
    const journal=r.meta.journal?`<span class="muted"> â€” ${escapeHtml(r.meta.journal)}</span>`:'';
    const title=escapeHtml(r.meta.title || r.doi);
    const authors=escapeHtml(r.meta.authors || '');
    const doiEnc=encodeURIComponent(r.doi);
    const warn=r.meta.title?'':`<span class="pill warn" title="ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§ã‚‚è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ">æœªå–å¾—</span>`;
    const sourceBadge = r.source ? `<span class="pill muted" title="ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—å…ƒ">${r.source}</span>` : '';

    // J-STAGEè¨˜äº‹ãƒšãƒ¼ã‚¸ï¼ˆæ¨å®šï¼‰: ãƒ¦ãƒ¼ã‚¶æ“ä½œã§BibTeXå–å¾—ã§ãã‚‹ã‚ˆã†ã«
    const jstageLink = jstageArticleUrl(r.doi);

    return `
      <div class="card">
        <div><a href="${doiUrl}" target="_blank" rel="noopener"><strong>${title}</strong></a>${year}${journal} ${warn}</div>
        <div class="muted">${authors}</div>
        <div class="row" style="margin:.4rem 0">${tags}</div>
        ${notes}
        <div class="row" style="margin-top:.6rem;align-items:center;gap:8px">
          <button class="pill btn" onclick="downloadBibtexUTF8('${doiEnc}')">BibTeXï¼ˆUTF-8ä¿å­˜ï¼‰</button>
          ${jstageLink?`<a class="pill" href="${jstageLink}" target="_blank" rel="noopener">J-STAGEã§BibTeX</a>`:''}
          ${sourceBadge}
          <code class="pill">${escapeHtml(r.doi)}</code>
        </div>
      </div>`;
  }).join('');

  document.getElementById('count').textContent = `${arr.length} ä»¶`;
}

/** â–¼ J-STAGE è¨˜äº‹ãƒšãƒ¼ã‚¸ã®æ¨å®šURLï¼ˆjaï¼‰ */
function jstageArticleUrl(doi){
  const p = parseJstageDoi(doi);
  if (!p) return '';
  // ä¾‹: https://www.jstage.jst.go.jp/article/jaed/3/0/3_11/_article/-char/ja/
  return `https://www.jstage.jst.go.jp/article/${encodeURIComponent(p.cdjournal)}/${encodeURIComponent(p.vol)}/${encodeURIComponent(p.no)}/${encodeURIComponent(p.vol+'_'+p.start)}/_article/-char/ja/`;
}

/** â–¼ BibTeXå–å¾—ï¼ˆCrossref â†’ CrossCite â†’ doi.orgï¼‰+ UTF-8+BOMã§ä¿å­˜
    â€» J-STAGE DOI ã¯ã“ã“ã§å¤±æ•—ã™ã‚‹å ´åˆãŒã‚ã‚‹ãŸã‚ã€ä¸Šã® â€œJ-STAGEã§BibTeXâ€ ã‚’ä½µç”¨ */
async function downloadBibtexUTF8(doiEnc){
  const doi = decodeURIComponent(doiEnc);
  const tryUrls = [
    'https://api.crossref.org/works/' + encodeURIComponent(doi) + '/transform/application/x-bibtex',
    'https://citation.crosscite.org/format?doi=' + encodeURIComponent(doi) + '&style=bibtex',
    'https://doi.org/' + encodeURIComponent(doi)
  ];
  let text=null;
  for (const u of tryUrls){
    try{
      const headers = u.includes('doi.org') ? { 'Accept':'application/x-bibtex' } : { 'Accept':'text/plain' };
      const res = await fetch(u, { headers, cache:'no-store' });
      if (res.ok){ text = await res.text(); break; }
    }catch{}
  }
  if (!text){ alert('BibTeXã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚J-STAGEãƒœã‚¿ãƒ³ã‹ã‚‰å–å¾—ã—ã¦ãã ã•ã„ã€‚'); return; }
  const blob = new Blob(["\uFEFF"+text], { type:'text/plain;charset=utf-8' });
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=(doi.replace(/[^\w.-]+/g,'_'))+'.bib'; document.body.appendChild(a); a.click(); a.remove();
}

boot();
</script>
</body>
</html>
